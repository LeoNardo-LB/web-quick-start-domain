schema: spec-driven

context: |
  Tech stack: Java 25, Spring Boot 4.0.2, MyBatis Plus 3.5.16
  Architecture: DDD 4-layer (Domain → Application → Infrastructure → Adapter)
  
  详细规范: AGENTS.md
  测试规范: test/AGENTS.md

  ═══════════════════════════════════════
  TDD 验证流程（apply 阶段必须遵守）
  ═══════════════════════════════════════
  
  【阶段1】每完成一个文件或小功能
  ├─ 动作: 运行 lsp_diagnostics 检查
  └─ 标准: 零错误
  
  【阶段2】TODOLIST 全部完成后
  ├─ 动作: 编写单元测试，进行冒烟测试
  ├─ 规范: 用 assert 确保所有分支情况都被覆盖
  └─ 标准: 通过率 100%
  
  【阶段3】所有开发任务完成后
  ├─ 动作: 编写集成测试，以顶层/次顶层方法为入口
  ├─ 规范: 检查多个单元集成后是否可用，覆盖重要分支
  └─ 标准: 通过率 100%
  
  【阶段4】单测+集测全部通过后
  ├─ 动作: 对项目中所有用例进行抽检
  ├─ 规模: 10% 单测 + 10% 集测
  └─ 标准: 通过率 100%

rules:
  tasks:
    # ═══════════════════════════════════════════════════════════════
    # TDD 强制规则 - 所有编码任务必须遵守
    # ═══════════════════════════════════════════════════════════════

    - "**[强制]** 每个编码任务必须符合 TDD 流程：🔴 Red → 🟢 Green → 🔵 Refactor"

    - "**[强制]** 任务格式必须包含 TDD 阶段标识："
    - "  - [ ] X.Y.1 **[测试]** 创建 XxxUTest.java - 验证 xxx 行为"
    - "  - [ ] X.Y.2 **[实现]** 创建 Xxx.java - 实现 xxx 功能"
    - "  - [ ] X.Y.3 **[验证]** 运行 lsp_diagnostics → 零错误"
    - "  - [ ] X.Y.4 **[验证]** 运行测试 → 通过"

    - "**[强制]** 禁止「先实现后测试」的反模式："
    - "  ❌ 错误：先写实现代码，最后补测试"
    - "  ✅ 正确：先写失败测试，再写最小实现"

    - "**[强制]** 测试覆盖率要求："
    - "  - 单元测试：assert 覆盖所有分支（正常、边界、异常）"
    - "  - 集成测试：以顶层/次顶层方法为入口，覆盖重要场景"
    - "  - 目标：通过率 100%"

    - "**[强制]** 每个任务完成后必须验证："
    - "  - 阶段1：lsp_diagnostics → 零错误"
    - "  - 阶段2：单元测试 → 100% 通过"
    - "  - 阶段3：集成测试 → 100% 通过"
    - "  - 阶段4：抽检 10% → 100% 通过"

    - "**[推荐]** 测试命名规范："
    - "  - 单元测试：XxxUTest.java（如 EventRepositoryUTest）"
    - "  - 集成测试：XxxITest.java（如 JpaMigrationITest）"
    - "  - 测试方法：should_xxx_when_xxx 或 xxx_returns_xxx"

    - "**[参考]** test/AGENTS.md 获取完整测试规范"
