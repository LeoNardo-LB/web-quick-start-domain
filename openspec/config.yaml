schema: spec-driven

context: |
  Tech stack: Java 25, Spring Boot 4.0.2, MyBatis Plus 3.5.16
  Architecture: DDD 4-layer (Domain → Application → Infrastructure → Adapter)
  
  详细规范: AGENTS.md
  测试规范: test/AGENTS.md

  ═══════════════════════════════════════════════════════════════════════════════
  TDD 核心：🔴 Red → 🟢 Green → 🔵 Refactor
  ═══════════════════════════════════════════════════════════════════════════════
  
  测试结构：Arrange → Act → Assert（或 Given → When → Then）

rules:
  tasks:
    - |
      **[强制-粒度]** TODO 必须严格按 tasks.md 的 X.Y.Z 三级粒度创建
      - X: 功能模块（如"验证器框架"）
      - X.Y: 功能点（如"验证错误值对象"）
      - X.Y.Z: 原子任务（测试/实现/验证）

    - "**[强制-分离]** `[测试]` 和 `[实现]` 任务必须分开创建"

    - |
      **[测试-金字塔]** 不同粒度的测试服务于不同目的：
      
      | 测试类型 | 位置     | 速度   | 数量 | 验证内容               |
      |----------|----------|--------|------|------------------------|
      | 单元测试 | X.Y 级别 | 快(ms) | 多   | 单个类/方法的业务逻辑   |
      | 集成测试 | X 级别   | 中(s)  | 中   | 组件间协作、外部交互    |

    - |
      **[测试-触发条件]** 单元测试和集成测试的触发规则：
      
      | 场景               | 单元测试 | 集成测试 | 说明                     |
      |--------------------|----------|----------|--------------------------|
      | Domain 纯逻辑      | 必须     | 可选     | 值对象、聚合根方法       |
      | Application 层     | 必须     | 必须     | AppService 集成多组件    |
      | Infrastructure 层  | 必须     | 推荐     | Repository、外部服务     |
      | Adapter 层         | 必须     | 必须     | Controller、Listener     |
      | 跨层交互/异常处理  | 必须     | 必须     | 全局异常、Validator      |

    - |
      **[测试-命名]** 命名规范：
      - 单元测试：XxxUTest.java（如 OrderAppServiceUTest）
      - 集成测试：XxxITest.java（如 OrderControllerITest）

    - |
      **[测试-覆盖]** 覆盖要求：
      - 单元测试：测试公共接口，覆盖正常/边界/异常分支
      - 集成测试：覆盖关键场景（至少 1 正常 + 1 异常）
      - 不测试：私有方法、琐碎代码（简单 getter/setter）

    - |
      **[测试-层级结构]** tasks.md 中的测试组织方式：
      
      ## X. 功能模块
      ### X.1 功能点A
      - [ ] X.1.1 **[测试]** 创建 XxxUTest.java
      - [ ] X.1.2 **[实现]** 创建 Xxx.java
      - [ ] X.1.3 **[验证]** lsp_diagnostics → 零错误
      - [ ] X.1.4 **[验证]** 运行 XxxUTest → 通过
      
      ### X.2 功能点B
      ...（同上结构）
      
      ### X.N 集成测试（该模块的 X 级别验证）
      - [ ] X.N.1 **[测试-集成]** 创建 XxxITest.java
      - [ ] X.N.2 **[验证]** 运行 XxxITest → 通过

    - "**[强制-前置]** 执行 `[实现]` 前，必须确认 `[测试]` 文件已存在"

    - |
      **[强制-禁止]** 禁止以下反模式：
      - 跳过测试直接实现
      - 先实现后补测试
      - 未通过验证就标记完成

    - |
      **[命令]** 验证命令：
      - LSP: lsp_diagnostics(filePath) → 零错误
      - 单测: mvn test -Dtest=XxxUTest -pl test
      - 集测: mvn test -Dtest=XxxITest -pl test
      - 启动: mvn test -Dtest=ApplicationStartupTests -pl test

    - |
      **[执行顺序]** 按模块顺序执行：
      1. 完成 X.Y 的单元测试 → 每个 X.Y.4 验证通过
      2. 完成 X 级别的集成测试 → X.N.2 验证通过
      3. 全部完成后 → 运行 ApplicationStartupTests

    - |
      **[模块检查]** 每完成一个 X 模块，确认：
      - 所有 X.Y 单元测试通过
      - 集成测试任务存在且通过（如适用）

    - |
      **[归档条件]** 满足以下条件方可归档：
      - 所有任务标记完成
      - 单元测试全部通过
      - 集成测试全部通过（如有）
      - ApplicationStartupTests 通过
      - 无 LSP 诊断错误
