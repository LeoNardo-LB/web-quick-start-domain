schema: spec-driven

context: |
  Tech stack: Java 25, Spring Boot 4.0.2, MyBatis Plus 3.5.16
  Architecture: DDD 4-layer (Domain → Application → Infrastructure → Adapter)
  
  详细规范: AGENTS.md
  测试规范: test/AGENTS.md

  ═══════════════════════════════════════════════════════════════════════════════
  TDD 核心：🔴 Red → 🟢 Green → 🔵 Refactor
  ═══════════════════════════════════════════════════════════════════════════════
  
  测试结构：Arrange → Act → Assert（或 Given → When → Then）

rules:
  proposal:
    - |
      **[前置澄清-树形]** 创建 proposal 前，必须进行动态树形澄清：
      
      **Phase 1: 确认主题列表**
      ```
      AI: 根据需求，我需要确认以下主题：
      1. [主题A] - 一句话描述
      2. [主题B] - 一句话描述
      3. [主题C] - 一句话描述
      ...
      请问需要补充或调整吗？
      ```
      
      **Phase 2: 逐节点深入（动态调整）**
      ```
      循环每个主题节点：
        AI: 让我们确认 [主题X]：
            - 基础问题1？
            - 基础问题2？
        用户: 回答
        AI: 根据你的回答，我需要进一步确认：
            - 追问细节1？
            - 追问细节2？
        用户: 回答
        ...（根据回答动态展开子节点，直到该主题澄清完毕）
      ```
      
      **Phase 3: 确认完整树**
      ```
      AI: 以下是我理解的完整澄清树：
      
      📋 [变更名称]
      ├── [主题A]
      │   ├── [子节点A1]: <澄清结论>
      │   └── [子节点A2]: <澄清结论>
      ├── [主题B]
      │   ├── [子节点B1]: <澄清结论>
      │   └── [子节点B2]: <澄清结论>
      └── [主题C]: <澄清结论>
      
      是否完整准确？可以继续生成 proposal 吗？
      ```
      
      **动态调整原则**：
      - 用户回答"不需要" → 跳过该分支，不展开子节点
      - 用户回答模糊 → 继续追问具体细节
      - 用户提出新主题 → 动态添加到树中
      - 用户说"跳过" → 标记为"待定"，后续补充
      
      **继续条件**：用户确认树结构完整，说"继续"/"可以"/"没问题"
      **暂停条件**：用户说"等等"/"有问题"/需要补充信息
      
      **禁止**：
      - 假设用户意图
      - 固定问题模板（必须根据回答动态调整）
      - 跳过澄清直接生成 proposal

  tasks:
    - |
      **[强制-粒度]** TODO 必须严格按 tasks.md 的 X.Y.Z 三级粒度创建
      - X: 功能模块（如"验证器框架"）
      - X.Y: 功能点（如"验证错误值对象"）
      - X.Y.Z: 原子任务（实现/验证/测试）

    - |
      **[阶段式测试]** 为提高 AI 编码效率，采用阶段式测试策略：
      
      | 阶段 | 内容 | 验证时机 | 验证命令 |
      |------|------|----------|----------|
      | 实现阶段 | 编写业务代码 | 每个文件完成后 | lsp_diagnostics |
      | 单测阶段 | 编写单元测试 | 模块所有实现完成后 | mvn test -Dtest=XxxUTest |
      | 集测阶段 | 编写集成测试 | 所有模块完成后 | mvn test -Dtest=XxxITest |
      | 启动验证 | Spring 上下文 | 所有测试通过后 | ApplicationStartupTests |

    - |
      **[测试-金字塔]** 不同粒度的测试服务于不同目的：
      
      | 测试类型 | 位置 | 速度 | 数量 | 验证内容 |
      |----------|------|------|------|----------|
      | 单元测试 | 每个类 | 快(ms) | 多 | 单个类的业务逻辑 |
      | 集成测试 | 入口类 | 中(s) | 少 | Controller、AppService、Repository |

    - |
      **[测试-触发条件]** 单元测试和集成测试的对象规则：
      
      | 类类型 | 单元测试 | 集成测试 | 说明 |
      |-------|----------|----------|------|
      | 值对象/实体 | 必须 | 不需要 | 纯逻辑，无依赖 |
      | 领域服务 | 必须 | 不需要 | 领域逻辑 |
      | AppService | 必须 | 必须 | 编排多组件 |
      | Repository | 必须 | 推荐 | 数据访问 |
      | Controller | 必须 | 必须 | API 入口 |
      | Validator | 必须 | 推荐 | 验证逻辑 |
      | Client 接口 | Mock 实现 | 不需要 | 接口契约 |
      | 配置类 | 不需要 | 启动验证 | Bean 装配 |

    - |
      **[测试-命名]** 命名规范：
      - 单元测试：XxxUTest.java（如 OrderAppServiceUTest）
      - 集成测试：XxxITest.java（如 OrderControllerITest）

    - |
      **[测试-覆盖]** 覆盖要求：
      - 单元测试：测试公共接口，覆盖正常/边界/异常分支
      - 集成测试：覆盖关键场景（至少 1 正常 + 1 异常）
      - 不测试：私有方法、琐碎代码（简单 getter/setter）

    - |
      **[阶段式任务结构]** tasks.md 任务组织原则：
      - 实现和测试任务分离到不同阶段
      - 每个文件完成后只做 LSP 检查
      - 模块内所有实现完成后，统一编写测试
      - 编译验证在测试之前，确保代码可编译
      
      **示例**：
      ```
      ## X. 功能模块
      
      ### X.1 值对象
      - [ ] X.1.1 **[实现]** 创建 XxxValueObject.java
      - [ ] X.1.2 **[验证]** lsp_diagnostics
      
      ### X.N 模块单元测试（阶段验证点）
      - [ ] X.N.1 **[测试]** 创建 XxxUTest.java
      - [ ] X.N.2 **[编译]** mvn clean compile
      - [ ] X.N.3 **[验证]** 运行单元测试
      
      ## Y. 集成测试
      - [ ] Y.1 **[测试-集成]** 创建 XxxControllerITest.java
      - [ ] Y.2 **[验证]** ApplicationStartupTests
      ```

    - |
      **[强制-禁止]** 禁止以下反模式：
      - 跳过单元测试直接进入集成测试
      - 先实现后不写测试
      - 删除失败测试以通过构建
      - 提交失败的测试代码

    - |
      **[验证命令]** 
      - LSP: `lsp_diagnostics(filePath)`
      - 编译: `mvn clean compile`
      - 单测: `mvn test -Dtest=XxxUTest -pl test`
      - 集测: `mvn test -Dtest=XxxITest -pl test`
      - 启动: `mvn test -Dtest=ApplicationStartupTests -pl test`

    - |
      **[归档条件]** 满足以下条件方可归档：
      - 所有实现任务标记完成
      - 所有测试通过（单元 + 集成 + 启动验证）
      - 无 LSP 诊断错误
